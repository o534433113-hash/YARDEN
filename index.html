<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoonGuard | LPR-Verify</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0c0c0c;
            --bg-secondary: #141414;
            --bg-card: #1a1a1a;
            --border-primary: #2a2a2a;
            --border-accent: #3d3d3d;
            --accent-green: #22c55e;
            --accent-green-dim: #166534;
            --accent-red: #dc2626;
            --accent-red-dim: #7f1d1d;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --text-muted: #525252;
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .mono { font-family: 'IBM Plex Mono', monospace; }
        
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
        }
        
        .panel-accent {
            border-left: 3px solid var(--accent-green);
        }
        
        .panel-alert {
            border-left: 3px solid var(--accent-red);
            background: linear-gradient(90deg, rgba(127, 29, 29, 0.15) 0%, var(--bg-card) 100%);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-online { background: var(--accent-green); }
        .status-offline { background: var(--accent-red); }
        
        .alert-indicator {
            animation: alertBlink 2s ease-in-out infinite;
        }
        
        @keyframes alertBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .scrollbar-minimal::-webkit-scrollbar { width: 4px; }
        .scrollbar-minimal::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .scrollbar-minimal::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 2px; }
        
        .btn {
            transition: all 0.15s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .lpr-display {
            font-family: 'IBM Plex Mono', monospace;
            letter-spacing: 2px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const API_BASE = window.location.origin;
        const WS_URL = `ws://${window.location.host}/ws`;

        // --- Components ---

        const ConnectionStatus = ({ isConnected }) => (
            <div className="flex items-center gap-2 text-sm">
                <span className={`status-indicator ${isConnected ? 'status-online' : 'status-offline'}`}></span>
                <span className={`mono text-xs ${isConnected ? 'text-green-500' : 'text-red-500'}`}>
                    {isConnected ? 'CONNECTED' : 'DISCONNECTED'}
                </span>
            </div>
        );

        const StatusBadge = ({ status, confidence }) => {
            const configs = {
                VERIFIED: { icon: 'fa-check', text: 'VERIFIED', color: 'text-green-500 bg-green-950 border-green-800' },
                ALERT: { icon: 'fa-exclamation-triangle', text: 'ALERT', color: 'text-red-500 bg-red-950 border-red-800' },
                UNKNOWN: { icon: 'fa-question', text: 'UNKNOWN', color: 'text-neutral-400 bg-neutral-900 border-neutral-700' },
                PROCESSING: { icon: 'fa-spinner fa-spin', text: 'PROCESSING', color: 'text-neutral-400 bg-neutral-900 border-neutral-700' },
                ERROR: { icon: 'fa-times', text: 'ERROR', color: 'text-red-500 bg-red-950 border-red-800' },
                FAKE_PLATE: { icon: 'fa-skull', text: 'FAKE PLATE', color: 'text-red-500 bg-red-950 border-red-700 font-semibold' },
                NO_LICENSE: { icon: 'fa-ban', text: 'NO LICENSE', color: 'text-orange-500 bg-orange-950 border-orange-800' },
                OFF_ROAD: { icon: 'fa-times-circle', text: 'OFF ROAD', color: 'text-neutral-400 bg-neutral-900 border-neutral-700' }
            };
            
            const config = configs[status] || configs.ERROR;
            
            return (
                <div className={`flex items-center gap-2 px-3 py-1.5 rounded border text-xs mono ${config.color}`}>
                    <i className={`fas ${config.icon}`}></i>
                    <span>{config.text}</span>
                    {confidence > 0 && <span className="text-neutral-500">({confidence}%)</span>}
                </div>
            );
        };

        const FolderSelector = ({ watcherStatus, onStartWatch, onStopWatch }) => {
            const inputRef = useRef(null);
            const [isLoading, setIsLoading] = useState(false);

            const handleStart = async () => {
                const folderPath = inputRef.current?.value?.trim();
                if (!folderPath) { alert('יש להזין נתיב לתיקייה'); return; }
                setIsLoading(true);
                try { await onStartWatch(folderPath); } finally { setIsLoading(false); }
            };

            const handleStop = async () => {
                setIsLoading(true);
                try { await onStopWatch(); if (inputRef.current) inputRef.current.value = ''; } finally { setIsLoading(false); }
            };

            return (
                <div className="panel panel-accent rounded-lg p-4 mb-6">
                    <div className="flex items-center justify-between flex-wrap gap-4">
                        <div className="flex items-center gap-4">
                            <div className={`w-10 h-10 rounded-lg border flex items-center justify-center ${
                                watcherStatus?.is_active 
                                    ? 'border-green-600 bg-green-950 text-green-500' 
                                    : 'border-neutral-700 bg-neutral-900 text-neutral-600'
                            }`}>
                                <i className={`fas ${watcherStatus?.is_active ? 'fa-radar' : 'fa-power-off'}`}></i>
                            </div>
                            <div>
                                <div className="font-semibold text-sm">
                                    {watcherStatus?.is_active 
                                        ? <span className="text-green-500">Monitoring Active</span> 
                                        : <span className="text-neutral-500">Monitoring Offline</span>
                                    }
                                </div>
                                {watcherStatus?.is_active && watcherStatus?.watched_folder && (
                                    <div className="text-xs text-neutral-500 mono truncate max-w-md">{watcherStatus.watched_folder}</div>
                                )}
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            {!watcherStatus?.is_active ? (
                                <>
                                    <input
                                        ref={inputRef}
                                        type="text"
                                        placeholder="C:\path\to\folder"
                                        className="bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2 text-sm w-80 focus:outline-none focus:border-neutral-500 mono text-neutral-300 placeholder-neutral-600"
                                        dir="ltr"
                                    />
                                    <button
                                        onClick={handleStart}
                                        disabled={isLoading}
                                        className={`btn px-5 py-2 rounded-lg font-medium flex items-center gap-2 text-sm ${
                                            isLoading
                                                ? 'bg-neutral-800 text-neutral-600 cursor-not-allowed'
                                                : 'bg-green-600 text-white hover:bg-green-500'
                                        }`}
                                    >
                                        {isLoading ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-play"></i>}
                                        <span>Start</span>
                                    </button>
                                </>
                            ) : (
                                <button
                                    onClick={handleStop}
                                    disabled={isLoading}
                                    className="btn px-5 py-2 rounded-lg font-medium flex items-center gap-2 bg-red-600 text-white hover:bg-red-500 text-sm"
                                >
                                    {isLoading ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-stop"></i>}
                                    <span>Stop</span>
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {watcherStatus?.is_active && (
                        <div className="mt-3 pt-3 border-t border-neutral-800 flex items-center gap-6 text-xs text-neutral-500 mono">
                            <span><i className="fas fa-clock ml-1"></i> Started: {watcherStatus.started_at ? new Date(watcherStatus.started_at).toLocaleTimeString('he-IL') : '-'}</span>
                            <span><i className="fas fa-file ml-1"></i> Processed: {watcherStatus.files_processed || 0}</span>
                        </div>
                    )}
                </div>
            );
        };

        const AlertCard = ({ event, onDismiss, onClick }) => {
            const time = event.display_time || new Date(event.timestamp).toLocaleTimeString('he-IL');
            const govData = event.gov_data || {};
            
            return (
                <div 
                    className="panel panel-alert rounded-lg p-3 mb-2 cursor-pointer hover:border-red-700 transition-colors"
                    onClick={() => onClick(event)}
                >
                    <div className="flex justify-between items-start">
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                                <i className="fas fa-exclamation-triangle text-red-500 text-xs alert-indicator"></i>
                                <span className="text-xs text-neutral-500 mono">{time}</span>
                                <span className="bg-neutral-800 px-2 py-0.5 rounded text-xs text-neutral-400 mono">{event.location_id}</span>
                            </div>
                            <div className="lpr-display text-lg text-red-400 mb-1">{event.lpr}</div>
                            <div className="text-xs text-neutral-500">{govData.manufacturer} {govData.model}</div>
                        </div>
                        <button 
                            onClick={(e) => { e.stopPropagation(); onDismiss(event.id || event.lpr); }}
                            className="text-neutral-600 hover:text-red-500 transition-colors p-1"
                        >
                            <i className="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            );
        };

        const StreamCard = ({ event, onDelete }) => {
            const time = event.display_time || new Date(event.timestamp).toLocaleTimeString('he-IL');
            const govData = event.gov_data || {};
            const aiAnalysis = event.ai_analysis || {};
            const isAlert = ['ALERT', 'FAKE_PLATE', 'NO_LICENSE', 'OFF_ROAD'].includes(event.status);
            const [imageError, setImageError] = useState(false);
            const imageUrl = event.image_filename ? `${API_BASE}/api/images/${event.image_filename}` : null;
            
            return (
                <div className={`panel rounded-lg overflow-hidden relative transition-all hover:border-neutral-600 ${isAlert ? 'border-red-900' : ''}`}>
                    <button
                        onClick={() => onDelete(event.id || event.lpr + event.timestamp)}
                        className="absolute top-2 right-2 z-10 w-6 h-6 rounded bg-black/70 hover:bg-red-600 text-neutral-500 hover:text-white flex items-center justify-center transition-all"
                    >
                        <i className="fas fa-times text-xs"></i>
                    </button>
                    
                    {imageUrl && !imageError && (
                        <div className="relative h-40 bg-neutral-900 cursor-pointer" title="Double-click to enlarge">
                            <img 
                                src={imageUrl}
                                alt={`Vehicle ${event.lpr}`}
                                className="w-full h-full object-cover"
                                onError={() => setImageError(true)}
                                onDoubleClick={() => window.dispatchEvent(new CustomEvent('openLightbox', { detail: { url: imageUrl, lpr: event.lpr } }))}
                            />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent pointer-events-none"></div>
                        </div>
                    )}
                    
                    <div className={`p-4 ${isAlert ? 'bg-red-950/20' : ''}`}>
                        <div className="flex justify-between items-center mb-3">
                            <span className="bg-neutral-800 px-2 py-1 rounded text-xs mono text-neutral-400">{event.location_id}</span>
                            <span className="text-neutral-500 text-xs mono">{time}</span>
                        </div>
                        
                        <div className="text-center mb-4">
                            <div className={`inline-block lpr-display text-2xl px-4 py-2 rounded border ${
                                isAlert ? 'text-red-400 border-red-800 bg-red-950/30' : 'text-green-400 border-green-800 bg-green-950/30'
                            }`}>
                                {event.lpr}
                            </div>
                        </div>
                        
                        <div className="space-y-3 text-sm">
                            <div>
                                <div className="text-xs text-neutral-500 uppercase tracking-wide mb-1">Vehicle Data</div>
                                {govData.found ? (
                                    <div>
                                        <div className="font-medium text-neutral-200">{govData.manufacturer} {govData.model}</div>
                                        <div className="text-xs text-neutral-500">
                                            {govData.color} {govData.year && `• ${govData.year}`}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-red-500 text-sm">Not found in database</div>
                                )}
                            </div>
                            
                            <div className="bg-neutral-900 rounded p-3">
                                <div className="text-xs text-neutral-500 uppercase tracking-wide mb-1">AI Analysis</div>
                                <p className="text-xs text-neutral-400 leading-relaxed">
                                    {aiAnalysis.best_match_details || aiAnalysis.scene_description || 'No analysis available'}
                                </p>
                            </div>
                            
                            <div className="flex justify-center pt-2">
                                <StatusBadge status={event.status} confidence={aiAnalysis.confidence || 0} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const StatsPanel = ({ stats }) => (
            <div className="flex gap-3">
                <div className="text-center px-4">
                    <div className="text-2xl font-semibold text-neutral-200">{stats.total_events}</div>
                    <div className="text-xs text-neutral-500 uppercase">Total</div>
                </div>
                <div className="w-px bg-neutral-800"></div>
                <div className="text-center px-4">
                    <div className="text-2xl font-semibold text-green-500">{stats.verified_count}</div>
                    <div className="text-xs text-neutral-500 uppercase">Verified</div>
                </div>
                <div className="w-px bg-neutral-800"></div>
                <div className="text-center px-4">
                    <div className="text-2xl font-semibold text-red-500">{stats.alert_count}</div>
                    <div className="text-xs text-neutral-500 uppercase">Alerts</div>
                </div>
                <div className="w-px bg-neutral-800"></div>
                <div className="text-center px-4">
                    <div className="text-2xl font-semibold text-neutral-400">{stats.unknown_count}</div>
                    <div className="text-xs text-neutral-500 uppercase">Unknown</div>
                </div>
            </div>
        );

        const Lightbox = ({ imageUrl, lpr, onClose }) => {
            const [zoom, setZoom] = useState(1);
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            const containerRef = useRef(null);
            
            const minZoom = 1;
            const maxZoom = 8;
            
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') onClose();
                    if (e.key === '+' || e.key === '=') handleZoomIn();
                    if (e.key === '-') handleZoomOut();
                    if (e.key === '0') handleReset();
                };
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [onClose, zoom]);
            
            const handleWheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.3 : 0.3;
                setZoom(prev => Math.min(maxZoom, Math.max(minZoom, prev + delta)));
            };
            
            const handleZoomIn = () => setZoom(prev => Math.min(maxZoom, prev + 0.5));
            const handleZoomOut = () => setZoom(prev => Math.max(minZoom, prev - 0.5));
            const handleReset = () => { setZoom(1); setPosition({ x: 0, y: 0 }); };
            
            const handleMouseDown = (e) => {
                if (zoom > 1) {
                    setIsDragging(true);
                    setDragStart({ x: e.clientX - position.x, y: e.clientY - position.y });
                }
            };
            
            const handleMouseMove = (e) => {
                if (isDragging && zoom > 1) {
                    setPosition({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
                }
            };
            
            const handleMouseUp = () => setIsDragging(false);
            
            const handleDoubleClick = (e) => {
                e.stopPropagation();
                if (zoom === 1) {
                    setZoom(3);
                } else {
                    handleReset();
                }
            };
            
            return (
                <div 
                    className="fixed inset-0 z-50 bg-black/95 flex items-center justify-center overflow-hidden"
                    onClick={onClose}
                    onWheel={handleWheel}
                >
                    {/* Controls */}
                    <div className="absolute top-4 left-4 right-4 flex justify-between items-center z-10" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="text-neutral-400 hover:text-white transition-colors text-sm bg-neutral-900/80 px-3 py-2 rounded-lg">
                            <i className="fas fa-times ml-2"></i> Close (ESC)
                        </button>
                        
                        <div className="flex items-center gap-2">
                            <button 
                                onClick={handleZoomOut}
                                disabled={zoom <= minZoom}
                                className="w-10 h-10 rounded-lg bg-neutral-900/80 text-neutral-300 hover:text-white hover:bg-neutral-800 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
                            >
                                <i className="fas fa-minus"></i>
                            </button>
                            <div className="px-3 py-2 bg-neutral-900/80 rounded-lg text-neutral-300 text-sm mono min-w-[70px] text-center">
                                {Math.round(zoom * 100)}%
                            </div>
                            <button 
                                onClick={handleZoomIn}
                                disabled={zoom >= maxZoom}
                                className="w-10 h-10 rounded-lg bg-neutral-900/80 text-neutral-300 hover:text-white hover:bg-neutral-800 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
                            >
                                <i className="fas fa-plus"></i>
                            </button>
                            <button 
                                onClick={handleReset}
                                className="w-10 h-10 rounded-lg bg-neutral-900/80 text-neutral-300 hover:text-white hover:bg-neutral-800 transition-all mr-2"
                                title="Reset (0)"
                            >
                                <i className="fas fa-compress-arrows-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    {/* LPR Display */}
                    <div className="absolute top-20 left-1/2 -translate-x-1/2 z-10" onClick={e => e.stopPropagation()}>
                        <div className="lpr-display text-xl text-green-400 bg-neutral-900/80 px-4 py-2 rounded-lg">{lpr}</div>
                    </div>
                    
                    {/* Image Container */}
                    <div 
                        ref={containerRef}
                        className="relative"
                        onClick={e => e.stopPropagation()}
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                        onDoubleClick={handleDoubleClick}
                        style={{ cursor: zoom > 1 ? (isDragging ? 'grabbing' : 'grab') : 'zoom-in' }}
                    >
                        <img 
                            src={imageUrl} 
                            alt={`Vehicle ${lpr}`}
                            className="max-w-[95vw] max-h-[85vh] object-contain rounded-lg select-none"
                            style={{
                                transform: `scale(${zoom}) translate(${position.x / zoom}px, ${position.y / zoom}px)`,
                                transition: isDragging ? 'none' : 'transform 0.15s ease-out'
                            }}
                            draggable={false}
                        />
                    </div>
                    
                    {/* Zoom Instructions */}
                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 text-neutral-500 text-xs bg-neutral-900/60 px-4 py-2 rounded-lg">
                        <span className="ml-4">Scroll: Zoom</span>
                        <span className="ml-4">Double-click: Toggle zoom</span>
                        <span>Drag: Pan (when zoomed)</span>
                    </div>
                </div>
            );
        };

        const Dashboard = () => {
            const [events, setEvents] = useState([]);
            const [dismissedAlerts, setDismissedAlerts] = useState(new Set());
            const [stats, setStats] = useState({ total_events: 0, verified_count: 0, alert_count: 0, unknown_count: 0 });
            const [watcherStatus, setWatcherStatus] = useState(null);
            const [isConnected, setIsConnected] = useState(false);
            const [lightboxImage, setLightboxImage] = useState(null);
            const [popupEvent, setPopupEvent] = useState(null);
            const [statusFilter, setStatusFilter] = useState('ALL');
            const wsRef = useRef(null);
            const reconnectTimeoutRef = useRef(null);
            
            useEffect(() => {
                const handleOpenLightbox = (e) => setLightboxImage(e.detail);
                window.addEventListener('openLightbox', handleOpenLightbox);
                return () => window.removeEventListener('openLightbox', handleOpenLightbox);
            }, []);
            
            useEffect(() => {
                const handleKeyDown = (e) => { if (e.key === 'Escape') setPopupEvent(null); };
                if (popupEvent) {
                    document.addEventListener('keydown', handleKeyDown);
                    return () => document.removeEventListener('keydown', handleKeyDown);
                }
            }, [popupEvent]);
            
            const dismissAlert = (eventId) => setDismissedAlerts(prev => new Set([...prev, eventId]));
            
            const deleteEvent = async (eventId) => {
                setEvents(prev => prev.filter(e => (e.id || e.lpr + e.timestamp) !== eventId));
                setDismissedAlerts(prev => { const s = new Set(prev); s.add(eventId); return s; });
                if (typeof eventId === 'number') {
                    try { await fetch(`${API_BASE}/api/events/${eventId}`, { method: 'DELETE' }); } catch (e) { console.error('Error:', e); }
                }
            };

            const connectWebSocket = useCallback(() => {
                if (wsRef.current?.readyState === WebSocket.OPEN) return;
                const ws = new WebSocket(WS_URL);
                ws.onopen = () => { setIsConnected(true); if (reconnectTimeoutRef.current) { clearTimeout(reconnectTimeoutRef.current); reconnectTimeoutRef.current = null; } };
                ws.onclose = () => { setIsConnected(false); reconnectTimeoutRef.current = setTimeout(connectWebSocket, 3000); };
                ws.onerror = (error) => console.error('WebSocket error:', error);
                ws.onmessage = (event) => { try { handleWebSocketMessage(JSON.parse(event.data)); } catch (e) { console.error('Parse error:', e); } };
                wsRef.current = ws;
            }, []);

            const handleWebSocketMessage = (message) => {
                switch (message.type) {
                    case 'new_event':
                        setEvents(prev => {
                            const newEvents = [message.data, ...prev];
                            const verifiedCount = newEvents.filter(e => e.status === 'VERIFIED').length;
                            if (verifiedCount >= 18) return newEvents.filter(e => e.status !== 'VERIFIED').slice(0, 100);
                            return newEvents.slice(0, 100);
                        });
                        break;
                    case 'stats_update': setStats(message.data); break;
                    case 'status_update': setWatcherStatus(message.data); break;
                    case 'events_cleared': if (message.data?.remaining) setEvents(message.data.remaining); break;
                }
            };

            const handleStartWatch = async (folderPath) => {
                try {
                    const response = await fetch(`${API_BASE}/api/watch/start`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folder_path: folderPath })
                    });
                    const data = await response.json();
                    if (!data.success) alert(`Error: ${data.message}`);
                } catch (e) { console.error('Error:', e); alert('Error starting monitor'); }
            };

            const handleStopWatch = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/watch/stop`, { method: 'POST' });
                    const data = await response.json();
                    if (!data.success) alert(`Error: ${data.message}`);
                } catch (e) { console.error('Error:', e); alert('Error stopping monitor'); }
            };

            useEffect(() => {
                connectWebSocket();
                return () => { if (wsRef.current) wsRef.current.close(); if (reconnectTimeoutRef.current) clearTimeout(reconnectTimeoutRef.current); };
            }, [connectWebSocket]);

            const alertStatuses = ['ALERT', 'FAKE_PLATE', 'NO_LICENSE', 'OFF_ROAD'];
            const alerts = events.filter(e => alertStatuses.includes(e.status) && !dismissedAlerts.has(e.id || e.lpr));

            const filteredEvents = events.filter(event => {
                if (statusFilter === 'ALL') return true;
                if (statusFilter === 'VERIFIED') return event.status === 'VERIFIED';
                if (statusFilter === 'ALERTS') return alertStatuses.includes(event.status);
                if (statusFilter === 'UNKNOWN') return event.status === 'UNKNOWN';
                return true;
            });

            return (
                <div className="min-h-screen p-6 bg-neutral-950">
                    {lightboxImage && <Lightbox imageUrl={lightboxImage.url} lpr={lightboxImage.lpr} onClose={() => setLightboxImage(null)} />}
                    
                    {popupEvent && (
                        <div className="fixed inset-0 z-40 bg-black/90 flex items-center justify-center p-4" onClick={() => setPopupEvent(null)}>
                            <div className="relative max-w-md w-full" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setPopupEvent(null)} className="absolute -top-12 left-0 text-neutral-400 hover:text-white transition-colors text-sm z-50">
                                    <i className="fas fa-times ml-2"></i> Close (ESC)
                                </button>
                                <StreamCard event={popupEvent} onDelete={(id) => { deleteEvent(id); setPopupEvent(null); }} />
                            </div>
                        </div>
                    )}
                    
                    {/* Header */}
                    <header className="panel rounded-lg p-5 mb-6 flex justify-between items-center flex-wrap gap-4">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-lg bg-green-950 border border-green-800 flex items-center justify-center">
                                <i className="fas fa-satellite-dish text-xl text-green-500"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-semibold text-neutral-100">
                                    MoonGuard <span className="text-neutral-500 font-normal">/ LPR-Verify</span>
                                </h1>
                                <p className="text-neutral-500 text-sm">Vehicle Verification System</p>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-8">
                            <StatsPanel stats={stats} />
                            <div className="pl-6 border-l border-neutral-800">
                                <ConnectionStatus isConnected={isConnected} />
                            </div>
                        </div>
                    </header>

                    <FolderSelector watcherStatus={watcherStatus} onStartWatch={handleStartWatch} onStopWatch={handleStopWatch} />

                    <div className="grid grid-cols-12 gap-6">
                        {/* Alerts Sidebar */}
                        <div className="col-span-12 lg:col-span-3">
                            <div className="panel rounded-lg p-4 min-h-[500px] max-h-[calc(100vh-400px)] overflow-y-auto scrollbar-minimal">
                                <h2 className="text-sm font-semibold text-red-500 mb-4 flex items-center sticky top-0 bg-neutral-900/95 py-2 -mt-2 -mx-4 px-4 border-b border-neutral-800">
                                    <i className="fas fa-exclamation-triangle ml-2"></i>
                                    Alerts
                                    {alerts.length > 0 && (
                                        <span className="mr-2 bg-red-900 text-red-400 text-xs px-2 py-0.5 rounded-full">{alerts.length}</span>
                                    )}
                                </h2>
                                
                                {alerts.length === 0 ? (
                                    <div className="text-center text-neutral-600 mt-16">
                                        <i className="fas fa-shield-alt text-3xl mb-3"></i>
                                        <p className="text-sm">No active alerts</p>
                                    </div>
                                ) : (
                                    alerts.map(event => (
                                        <AlertCard key={event.id || event.lpr + event.timestamp} event={event} onDismiss={dismissAlert} onClick={(e) => setPopupEvent(e)} />
                                    ))
                                )}
                            </div>
                        </div>

                        {/* Live Feed */}
                        <div className="col-span-12 lg:col-span-9">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-4">
                                    <h2 className="text-sm font-semibold text-neutral-300 flex items-center">
                                        <i className="fas fa-stream ml-2 text-green-500"></i>
                                        Live Feed
                                    </h2>
                                    {events.length > 0 && (
                                        <button
                                            onClick={async () => { 
                                                try {
                                                    const response = await fetch(`${API_BASE}/api/events/clear/non-alerts`, { method: 'DELETE' });
                                                    const result = await response.json();
                                                    if (result.success) setEvents(prev => prev.filter(e => alertStatuses.includes(e.status)));
                                                } catch (e) { console.error('Error:', e); }
                                            }}
                                            className="btn px-3 py-1.5 rounded text-xs flex items-center gap-2 bg-neutral-800 border border-neutral-700 text-neutral-400 hover:text-red-400 hover:border-red-800"
                                        >
                                            <i className="fas fa-trash-alt"></i>
                                            <span>Clear</span>
                                        </button>
                                    )}
                                </div>
                                <div className="flex gap-1 text-xs">
                                    {['ALL', 'VERIFIED', 'ALERTS', 'UNKNOWN'].map(filter => (
                                        <button
                                            key={filter}
                                            onClick={() => setStatusFilter(filter)}
                                            className={`btn px-3 py-1.5 rounded transition-all border ${
                                                statusFilter === filter 
                                                    ? filter === 'ALERTS' 
                                                        ? 'bg-red-900/50 text-red-400 border-red-700' 
                                                        : 'bg-green-900/50 text-green-400 border-green-700'
                                                    : 'bg-neutral-900 text-neutral-500 border-neutral-800 hover:border-neutral-600'
                                            }`}
                                        >
                                            {filter === 'VERIFIED' && <span className="w-1.5 h-1.5 rounded-full bg-green-500 inline-block mr-1"></span>}
                                            {filter === 'ALERTS' && <span className="w-1.5 h-1.5 rounded-full bg-red-500 inline-block mr-1"></span>}
                                            {filter === 'UNKNOWN' && <span className="w-1.5 h-1.5 rounded-full bg-neutral-500 inline-block mr-1"></span>}
                                            {filter === 'ALL' ? 'All' : filter.charAt(0) + filter.slice(1).toLowerCase()}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                {filteredEvents.map(event => (
                                    <StreamCard key={event.id || event.lpr + event.timestamp} event={event} onDelete={deleteEvent} />
                                ))}
                                
                                {events.length === 0 && (
                                    <div className="col-span-full py-20 text-center border border-dashed border-neutral-800 rounded-lg text-neutral-600">
                                        <i className="fas fa-satellite-dish text-4xl mb-4"></i>
                                        <p className="text-sm mb-2">Awaiting Input</p>
                                        <p className="text-xs text-neutral-700">Select a folder to start monitoring</p>
                                    </div>
                                )}
                                
                                {events.length > 0 && filteredEvents.length === 0 && (
                                    <div className="col-span-full py-16 text-center border border-dashed border-neutral-800 rounded-lg text-neutral-600">
                                        <i className="fas fa-filter text-3xl mb-3"></i>
                                        <p className="text-sm">No matching events</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
